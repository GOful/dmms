<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title>ë””íŠ¸ë¡œ ë§¨í™€ê´€ë¦¬ ì‹œìŠ¤í…œ(DMMS) v4.1 - AI í†µí•©í˜•</title>
    <style>
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; font-family: 'Malgun Gothic', sans-serif; overflow: hidden; }
        #app-container { display: flex; width: 100%; height: 100%; position: relative; }
        #sidebar { width: 320px; height: 100%; background: #fff; border-right: 1px solid #ddd; z-index: 10; display: flex; flex-direction: column; transition: transform 0.3s ease; }
        #app-container.sidebar-hidden #sidebar { transform: translateX(-320px); position: absolute; }
        .sidebar-header { padding: 25px 20px; background: #2c3e50; color: #fff; font-size: 19px; font-weight: bold; }        
        
        #tree-container { flex: 1; overflow-y: auto; background: #fff; }
        .tree-group-header { padding: 12px 20px; background: #fff; border-bottom: 1px solid #eee; cursor: pointer; font-weight: bold; display: flex; justify-content: space-between; user-select: none; }
        .line-header { background: #f8f9fa; color: #2c3e50; border-left: 5px solid #2c3e50; }
        .station-header { padding-left: 35px; font-weight: normal; font-size: 14px; border-bottom: 1px dashed #eee; }
        .tree-group-content { display: none; }
        .tree-group-content.show { display: block; }
        .manhole-item { padding: 8px 20px 8px 55px; cursor: pointer; font-size: 13px; border-bottom: 1px solid #f9f9f9; }
        .manhole-item:hover { background: #f1f3f5; }
        .manhole-item.active { background: #e3f2fd; border-left: 4px solid #2196f3; }
        
        #ai-chat-container { border-top: 2px solid #2c3e50; background: #f8f9fa; display: flex; flex-direction: column; height: 35%; }
        #chat-history { flex: 1; overflow-y: auto; padding: 10px; font-size: 13px; border-bottom: 1px solid #ddd; }
        .chat-msg { margin-bottom: 10px; padding: 8px; border-radius: 5px; max-width: 90%; word-break: break-all; }
        .user-msg { background: #e3f2fd; align-self: flex-end; margin-left: auto; border: 1px solid #bbdefb; }
        .ai-msg { background: #fff; align-self: flex-start; border: 1px solid #ddd; white-space: pre-wrap; }
        .chat-input-area { padding: 10px; display: flex; gap: 5px; }
        #chat-input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 4px; outline: none; }
        #send-btn { padding: 8px 12px; background: #2c3e50; color: white; border: none; border-radius: 4px; cursor: pointer; }
        #send-btn:disabled { background: #95a5a6; }

        #main-content { flex: 1; display: flex; flex-direction: column; position: relative; }
        #map { flex: 1; }

        #roadview { height: 35%; border-top: 4px solid #2c3e50; background: #eee; }
        #toggle-sidebar-btn { position: absolute; top: 15px; left: 330px; z-index: 20; background: #2c3e50; color: white; border: none; border-radius: 4px; padding: 10px; cursor: pointer; transition: left 0.3s ease; }
        #app-container.sidebar-hidden #toggle-sidebar-btn { left: 10px; }
    </style>
</head>
<body>

<div id="app-container">
    <button id="toggle-sidebar-btn" onclick="toggleSidebar()">â—€ ë¦¬ìŠ¤íŠ¸</button>
    <div id="sidebar">
        <div class="sidebar-header">ë””íŠ¸ë¡œ ë§¨í™€ê´€ë¦¬ ì‹œìŠ¤í…œ</div>
        <div id="tree-container"></div>
        
        <div id="ai-chat-container">
            <div id="chat-history">
                <div class="chat-msg ai-msg">ì•ˆë…•í•˜ì„¸ìš”! ë¡œë“œëœ ë§¨í™€ ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì§ˆë¬¸ì— ë‹µë³€í•´ ë“œë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
            </div>
            <div class="chat-input-area">
                <input type="text" id="chat-input" placeholder="ë§¨í™€ ì •ë³´ ë¬¼ì–´ë³´ê¸°..." autocomplete="off">
                <button id="send-btn" onclick="askAI()">ì „ì†¡</button>
            </div>
        </div>
    </div>
    <div id="main-content">
        <div id="map"></div>
        <div id="roadview"></div>
    </div>
</div>

<script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=bfdc537ae38f2581f61b334ea4034de6&libraries=services"></script>

<script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    // API ë° ëª¨ë¸ ì„¤ì •
    const API_KEY = "AIzaSyAs7AMkUkPCVr-lK01naoUNZHBGFFPJsCk"; 
    const genAI = new GoogleGenerativeAI(API_KEY);
    const model = genAI.getGenerativeModel({ model: "gemma-3-27b-it" });

    let map, rv, rvClient, rawData = null;
    let markersMap = {};
    const starImg = new kakao.maps.MarkerImage('https://t1.daumcdn.net/localimg/localimages/07/mapapidoc/markerStar.png', new kakao.maps.Size(24, 35));

    // UI ì œì–´ í•¨ìˆ˜
    window.toggleSidebar = () => {
        const container = document.getElementById('app-container');
        container.classList.toggle('sidebar-hidden');
        const btn = document.getElementById('toggle-sidebar-btn');
        btn.innerText = container.classList.contains('sidebar-hidden') ? "â–¶ ë¦¬ìŠ¤íŠ¸" : "â—€ ë¦¬ìŠ¤íŠ¸";
        setTimeout(() => { if(map) map.relayout(); }, 300);
    };

    window.toggleGroup = (id) => {
        const el = document.getElementById(id);
        const arrow = document.getElementById('arrow-' + id);
        if(el) {
            el.classList.toggle('show');
            if(arrow) arrow.innerText = el.classList.contains('show') ? 'â–²' : 'â–¼';
        }
    };

    // ë°ì´í„° ì´ˆê¸°í™”
    async function init() {
        map = new kakao.maps.Map(document.getElementById('map'), { center: new kakao.maps.LatLng(35.8714, 128.6014), level: 7 });
        rv = new kakao.maps.Roadview(document.getElementById('roadview'));
        rvClient = new kakao.maps.RoadviewClient();

        try {
            const res = await fetch('manholes.json');
            rawData = await res.json();
            renderTree();
        } catch (e) { 
            console.error("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:", e);
            document.getElementById('tree-container').innerHTML = "<p style='padding:20px;'>manholes.json íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>";
        }
    }

    // íŠ¸ë¦¬ ë Œë”ë§ ë° ë§ˆì»¤ ìƒì„±
    function renderTree() {
        const container = document.getElementById('tree-container');
        container.innerHTML = ""; 

        rawData.lines.forEach(line => {
            const div = document.createElement('div');
            div.innerHTML = `
                <div class="tree-group-header line-header" onclick="toggleGroup('${line.lineId}')">
                    <span>ğŸš‡ ${line.lineTitle}</span> <span id="arrow-${line.lineId}">â–¼</span>
                </div>
                <div id="${line.lineId}" class="tree-group-content"></div>
            `;
            container.appendChild(div);
            
            const lineContent = document.getElementById(line.lineId);
            line.stations.forEach(st => {
                const stDiv = document.createElement('div');
                stDiv.innerHTML = `
                    <div class="tree-group-header station-header" onclick="toggleGroup('${st.stationId}')">
                        <span>ğŸš‰ ${st.stationName}</span> <span id="arrow-${st.stationId}">â–¼</span>
                    </div>
                    <div id="${st.stationId}" class="tree-group-content"></div>
                `;
                lineContent.appendChild(stDiv);
                
                const stContent = document.getElementById(st.stationId);
                st.manholes.forEach(mh => {
                    const pos = new kakao.maps.LatLng(mh.lat, mh.lng);
                    const marker = new kakao.maps.Marker({ position: pos, map: map });
                    markersMap[mh.id] = { marker, pos, data: mh, stationName: st.stationName };

                    const item = document.createElement('div');
                    item.className = 'manhole-item';
                    item.innerText = `[${mh.id}] ${mh.name}`;
                    item.onclick = () => selectManhole(mh.id);
                    stContent.appendChild(item);
                    
                    kakao.maps.event.addListener(marker, 'click', () => selectManhole(mh.id));
                });
            });
        });
    }

    function selectManhole(id) {
        const target = markersMap[id];
        if(!target) return;
        map.panTo(target.pos);
        Object.values(markersMap).forEach(m => m.marker.setImage(null));
        target.marker.setImage(starImg);
        rvClient.getNearestPanoId(target.pos, 50, (pId) => { if(pId) rv.setPanoId(pId, target.pos); });
    }

    // AIì—ê²Œ ì „ë‹¬í•  ë°ì´í„° ìš”ì•½
    function getSystemContext() {
        if (!rawData) return "í˜„ì¬ ì‹œìŠ¤í…œì— ë¡œë“œëœ ë§¨í™€ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.";
        
        let summary = "ê´€ë¦¬ ì¤‘ì¸ ë§¨í™€ ëª©ë¡:\n";
        rawData.lines.forEach(line => {
            line.stations.forEach(st => {
                st.manholes.forEach(mh => {
                    summary += `- ID: ${mh.id}, ì´ë¦„: ${mh.name}, ìœ„ì¹˜: ${st.stationName} ì¸ê·¼ (ì¢Œí‘œ: ${mh.lat}, ${mh.lng})\n`;
                });
            });
        });
        return summary;
    }

    // AI ì§ˆë‹µ ë¡œì§
    window.askAI = async () => {
        const input = document.getElementById('chat-input');
        const history = document.getElementById('chat-history');
        const sendBtn = document.getElementById('send-btn');
        const userMsg = input.value.trim();

        if (!userMsg) return;

        // UI ì—…ë°ì´íŠ¸
        history.innerHTML += `<div class="chat-msg user-msg">${userMsg}</div>`;
        input.value = "";
        input.disabled = true;
        sendBtn.disabled = true;

        const loadingId = "loading-" + Date.now();
        history.innerHTML += `<div id="${loadingId}" class="chat-msg ai-msg">Gemmaê°€ ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...</div>`;
        history.scrollTop = history.scrollHeight;

        try {
            const context = getSystemContext();
            console.log("AIì—ê²Œ ì „ë‹¬ë˜ëŠ” ì „ì²´ ì»¨í…ìŠ¤íŠ¸:\n", context);
            const prompt = `
                ë„ˆëŠ” 'ë””íŠ¸ë¡œ ë§¨í™€ê´€ë¦¬ ì‹œìŠ¤í…œ'ì˜ ì§€ì‹ ì„œë¹„ìŠ¤ ë„ìš°ë¯¸ Gemmaì•¼.
                ë‹¤ìŒì˜ ì‹¤ì œ ê´€ë¦¬ ë°ì´í„°ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì‚¬ìš©ìì˜ ì§ˆë¬¸ì— ë‹µë³€í•´ì¤˜.
                
                [ê´€ë¦¬ ë°ì´í„° ìš”ì•½]
                ${context}
                
                [ì‚¬ìš©ì ì§ˆë¬¸]
                ${userMsg}
                
                ìœ„ ë°ì´í„°ì— ì´ë¦„ì´ë‚˜ IDê°€ ì–¸ê¸‰ë˜ì–´ ìˆë‹¤ë©´ ê·¸ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¹œì ˆí•˜ê²Œ ì„¤ëª…í•´ì¤˜.`;

            const result = await model.generateContent(prompt);
            const response = await result.response;
            
            document.getElementById(loadingId).remove();
            history.innerHTML += `<div class="chat-msg ai-msg">${response.text()}</div>`;
        } catch (error) {
            console.error(error);
            const loadingEl = document.getElementById(loadingId);
            if (loadingEl) loadingEl.innerText = "ì£„ì†¡í•©ë‹ˆë‹¤. ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆê±°ë‚˜ í• ë‹¹ëŸ‰ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤.";
        } finally {
            input.disabled = false;
            sendBtn.disabled = false;
            input.focus();
            history.scrollTop = history.scrollHeight;
        }
    };

    document.getElementById('chat-input').onkeypress = (e) => { if (e.key === 'Enter') window.askAI(); };
    
    // ì‹¤í–‰
    init();
</script>
</body>
</html>