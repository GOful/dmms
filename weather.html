<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ëŒ€êµ¬ ì‹¤ì‹œê°„ ì˜ˆë³´ - ëˆˆ/ë¹„ ì •ë³´ í¬í•¨</title>
    <style>
        :root { --primary-color: #1a73e8; --bg-color: #f0f2f5; --accent-snow: #0077b6; }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background-color: var(--bg-color); padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 700px; background: white; padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h2 { color: var(--primary-color); text-align: center; margin-top: 0; }
        
        .info-box { background: #e8f0fe; padding: 15px; border-radius: 8px; font-size: 0.9em; color: #1967d2; margin-bottom: 20px; }
        .param-list { list-style: none; padding: 0; margin: 10px 0 0 0; display: grid; grid-template-columns: 1fr 1fr; gap: 5px; border-top: 1px solid #c2d7fa; padding-top: 10px; }
        .param-list li { color: #555; }
        .param-list b { color: #1a73e8; }

        .btn-container { text-align: center; margin-bottom: 25px; }
        button { padding: 14px 28px; background-color: var(--primary-color); color: white; border: none; cursor: pointer; border-radius: 8px; font-weight: bold; transition: 0.3s; }
        button:hover { background-color: #1557b0; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 10px; border-radius: 8px; overflow: hidden; box-shadow: 0 0 0 1px #ddd; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: center; }
        th { background-color: #f8f9fa; }
        
        /* ê°•ì¡° ìŠ¤íƒ€ì¼ */
        .temp-val { color: #d93025; font-weight: bold; }
        .snow-text { color: var(--accent-snow); font-weight: bold; }
        .rain-text { color: #1a73e8; font-weight: bold; }

        details { margin-top: 30px; border-top: 2px dashed #ddd; padding-top: 15px; }
        summary { cursor: pointer; font-weight: bold; color: #5f6368; padding: 12px; background: #eee; border-radius: 6px; outline: none; }
        pre { background: #1e1e1e; color: #d4d4d4; padding: 20px; border-radius: 8px; overflow-x: auto; font-family: 'Consolas', monospace; font-size: 0.85em; line-height: 1.6; max-height: 400px; white-space: pre; border: 1px solid #333; margin-top: 10px; }

        .alert { padding: 15px; background-color: #fff3cd; border: 1px solid #ffeeba; border-radius: 8px; color: #856404; text-align: center; }
        .alert a { display: inline-block; margin-top: 10px; padding: 8px 16px; background: #856404; color: white; text-decoration: none; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸ™ï¸ ëŒ€êµ¬ ì‹¤ì‹œê°„ ë‚ ì”¨ ì˜ˆë³´</h2>
    
    <div id="status-info" class="info-box">
        <strong>ğŸ“¡ ì‹œìŠ¤í…œ ìƒíƒœ:</strong> ëŒ€ê¸° ì¤‘...
        <ul id="param-display" class="param-list">
            <li>ë‚ ì§œ: <b>-</b></li> <li>ì‹œê°„: <b>-</b></li>
            <li>nx: <b>-</b></li> <li>ny: <b>-</b></li>
        </ul>
    </div>
    
    <div class="btn-container">
        <button onclick="main()">ì‹¤ì‹œê°„ ì˜ˆë³´ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    </div>

    <div id="result"></div>
    <div id="raw-data-area"></div>
</div>

<script>
    const PROXY_URL = "https://cors-anywhere.herokuapp.com/";
    const AUTH_KEY = "-MBhNUogT9uAYTVKIL_bWA";
    const NX = 89; 
    const NY = 90; 

    // ê°•ìˆ˜í˜•íƒœ(PTY) ì½”ë“œë¥¼ í…ìŠ¤íŠ¸ë¡œ ë³€í™˜í•˜ëŠ” í•¨ìˆ˜
    function translatePty(code) {
        const ptyMap = {
            "0": "ê°•ìˆ˜ ì—†ìŒ",
            "1": "ë¹„ ğŸŒ§ï¸",
            "2": "ë¹„/ëˆˆ ğŸŒ¨ï¸",
            "3": "ëˆˆ â„ï¸",
            "5": "ë¹—ë°©ìš¸",
            "6": "ë¹—ë°©ìš¸/ëˆˆë‚ ë¦¼",
            "7": "ëˆˆë‚ ë¦¼"
        };
        return ptyMap[code] || "ì •ë³´ ì—†ìŒ";
    }

    function formatXml(xml) {
        let formatted = '';
        let reg = /(>)(<)(\/*)/g;
        xml = xml.replace(reg, '$1\r\n$2$3');
        let pad = 0;
        xml.split('\r\n').forEach(function(node) {
            let indent = 0;
            if (node.match( /.+<\/\w[^>]*>$/ )) indent = 0;
            else if (node.match( /^<\/\w/ )) { if (pad != 0) pad -= 1; }
            else if (node.match( /^<\w[^>]*[^\/]>.*$/ )) indent = 1;
            else indent = 0;
            let padding = '';
            for (let i = 0; i < pad; i++) padding += '  ';
            formatted += padding + node + '\r\n';
            pad += indent;
        });
        return formatted.trim();
    }

    function escapeXml(unsafe) {
        return unsafe.replace(/[<>&'"]/g, c => {
            switch (c) {
                case '<': return '&lt;'; case '>': return '&gt;';
                case '&': return '&amp;'; case '\'': return '&apos;';
                case '"': return '&quot;';
            }
        });
    }

    async function checkProxy() {
        try {
            const response = await fetch(PROXY_URL, { method: 'GET' });
            return response.status !== 403;
        } catch (e) { return false; }
    }

    function getKmaBaseTime() {
        const now = new Date();
        let hours = now.getHours();
        let minutes = now.getMinutes();
        if (minutes < 30) {
            if (hours === 0) hours = 23; 
            else hours -= 1;
        }
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return { base_date: `${year}${month}${day}`, base_time: `${String(hours).padStart(2, '0')}30` };
    }

    async function main() {
        const resultDiv = document.getElementById('result');
        const rawArea = document.getElementById('raw-data-area');
        const paramDisplay = document.getElementById('param-display');
        
        resultDiv.innerHTML = "<strong>ë°ì´í„° ë¡œë”© ì¤‘...</strong>";
        rawArea.innerHTML = "";

        const isReady = await checkProxy();
        if (!isReady) {
            resultDiv.innerHTML = `<div class="alert"><strong>âš ï¸ í”„ë¡ì‹œ ê¶Œí•œ í•„ìš”</strong><br><a href="${PROXY_URL}corsdemo" target="_blank">ì—¬ê¸°ì„œ í™œì„±í™”</a> í›„ ë‹¤ì‹œ ì‹œë„í•˜ì„¸ìš”.</div>`;
            return;
        }

        const { base_date, base_time } = getKmaBaseTime();
        paramDisplay.innerHTML = `<li>ë‚ ì§œ: <b>${base_date}</b></li><li>ì‹œê°„: <b>${base_time}</b></li><li>nx: <b>${NX}</b></li><li>ny: <b>${NY}</b></li>`;

        const targetUrl = `https://apihub.kma.go.kr/api/typ02/openApi/VilageFcstInfoService_2.0/getUltraSrtFcst?pageNo=1&numOfRows=1000&dataType=XML&base_date=${base_date}&base_time=${base_time}&nx=${NX}&ny=${NY}&authKey=${AUTH_KEY}`;

        try {
            const response = await fetch(PROXY_URL + targetUrl);
            const xmlText = await response.text();
            
            const prettyXml = formatXml(xmlText);
            rawArea.innerHTML = `<details><summary>ğŸ“„ ì›ë³¸ ë°ì´í„°(XML) ê³„ì¸µ êµ¬ì¡° ë³´ê¸°</summary><pre>${escapeXml(prettyXml)}</pre></details>`;

            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(xmlText, "text/xml");
            const items = xmlDoc.getElementsByTagName("item");

            if (items.length === 0) {
                resultDiv.innerHTML = "<p>ìš”ì²­ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>";
                return;
            }

            // PTY(ê°•ìˆ˜í˜•íƒœ) í•­ëª© ì¶”ê°€
            const categoryMap = { 
                "T1H": "ê¸°ì˜¨(â„ƒ)", 
                "RN1": "1ì‹œê°„ ê°•ìˆ˜ëŸ‰(mm)", 
                "PTY": "ê°•ìˆ˜í˜•íƒœ", 
                "REH": "ìŠµë„(%)", 
                "WSD": "í’ì†(m/s)" 
            };
            
            let tableHtml = `<table><thead><tr><th>ì‹œê°„</th><th>í•­ëª©</th><th>ì˜ˆë³´ê°’</th></tr></thead><tbody>`;

            for (let item of items) {
                const cat = item.getElementsByTagName("category")[0].textContent;
                if (categoryMap[cat]) {
                    const time = item.getElementsByTagName("fcstTime")[0].textContent;
                    let val = item.getElementsByTagName("fcstValue")[0].textContent;
                    let cellClass = "";

                    // ê¸°ì˜¨ ìŠ¤íƒ€ì¼
                    if (cat === "T1H") cellClass = "temp-val";
                    
                    // ê°•ìˆ˜í˜•íƒœ ì½”ë“œ ë³€í™˜ ë° ìŠ¤íƒ€ì¼
                    if (cat === "PTY") {
                        if (val !== "0") {
                            cellClass = (val === "3" || val === "2") ? "snow-text" : "rain-text";
                        }
                        val = translatePty(val);
                    }

                    tableHtml += `<tr><td>${time.substring(0,2)}ì‹œ</td><td>${categoryMap[cat]}</td><td class="${cellClass}">${val}</td></tr>`;
                }
            }
            tableHtml += "</tbody></table>";
            resultDiv.innerHTML = tableHtml;
            document.getElementById('status-info').firstChild.textContent = "ğŸ“¡ ì‹œìŠ¤í…œ ìƒíƒœ: ìˆ˜ì‹  ì™„ë£Œ";

        } catch (error) {
            resultDiv.innerHTML = "<p style='color:red;'>ë°ì´í„° ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ</p>";
        }
    }
</script>

</body>
</html>